# Aegis Secrets

Encrypted secrets for infrastructure. All files are encrypted with age - this repo is safe to be public.

## Structure

```
aegis-secrets/
├── src/                          # Source configuration (input to build)
│   ├── hosts/
│   │   └── <hostname>.toml       # Host configuration
│   ├── domains/
│   │   └── <domain>.toml         # Domain configuration  
│   ├── roles/
│   │   └── <role>.toml           # Role configuration
│   ├── users/
│   │   └── <username>.toml       # User configuration
│   └── kerberos/
│       └── realms/
│           └── <REALM>/
│               ├── realm.key.age # Encrypted realm master key
│               └── principals/   # Encrypted principal keys
├── keys/
│   ├── admin.pub                 # Admin public key
│   └── users/
│       └── <username>.age        # User private keys (encrypted for admin)
└── build/                        # Build output (generated by `aegis build`)
    ├── hosts/
    │   └── <hostname>/
    │       ├── ssh-keys.age      # Encrypted for host + admin
    │       ├── keytab.age        # Encrypted for host + KDC role + admin
    │       └── users/
    │           └── <username>/
    │               ├── env/      # User env vars for this host
    │               └── files/    # User files for this host
    ├── domains/
    │   └── <domain>/
    │       └── ...
    ├── roles/
    │   ├── <role>.age            # Role private key
    │   └── <role>.pub            # Role public key
    └── kdc/
        └── <REALM>-principals.age # All principals for KDC
```

## Usage

### As a flake input

```nix
{
  inputs.aegis-secrets.url = "github:fudoniten/aegis-secrets";
}

# Then use:
# inputs.aegis-secrets.hosts.nostromo  -> path to nostromo's secrets
# inputs.aegis-secrets.lib.hostSecretsPath "nostromo"
```

### Building secrets

```bash
# Option 1: Set environment variable
export AEGIS_SYSTEM=/path/to/aegis-secrets
aegis build

# Option 2: Run from within the repo
cd aegis-secrets
aegis build

# Option 3: Explicit path
aegis build --secrets-path /path/to/aegis-secrets

# Individual build steps
aegis build-ssh-keys
aegis build-keytabs
aegis build-user-secrets
```

### Environment Variables

| Variable | Description |
|----------|-------------|
| `AEGIS_SYSTEM` | Path to this secrets repository (for `aegis` CLI) |

## Security

- All `.age` files are encrypted with age
- Host secrets encrypted for: host master-key + admin
- Keytabs encrypted for: host + KDC role + admin
- User secrets encrypted for: target hosts + admin
- This repo can safely be public

## Adding secrets

See [aegis-tools-system](../aegis-tools-system) for the admin CLI.

```bash
# Add a host
aegis init-host myhost

# Add a user
aegis add-user alice --hosts=host1,host2

# Build everything
aegis build
```
